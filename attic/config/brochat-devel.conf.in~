# ====================================================================
# BroChat Development Nginx Configuration
# Copyright (c) 2025 Michael Zran
#
# WARNING: THIS CONFIGURATION IS INTENDED FOR DEVELOPMENT ONLY. IT IS NOT 
# OPTIMIZED FOR SECURITY, PERFORMANCE, OR STABILITY IN A PRODUCTION ENVIRONMENT.
#
# NO WARRANTY: THIS SOFTWARE IS PROVIDED "AS IS" WITHOUT ANY EXPRESS OR
# IMPLIED WARRANTIES. USE AT YOUR OWN RISK.
#
# THIS CONFIGURATION MAY ALLOW DEBUGGING FEATURES, AUTOINDEXING, AND RELAXED 
# SECURITY RULES FOR EASE OF DEVELOPMENT. IT SHOULD NEVER BE USED IN A PUBLICLY 
# ACCESSIBLE SERVER.
#
# By using this configuration, you accept full responsibility for any security 
# risks, data integrity issues, or unexpected behavior.
#
# This file was primarily AI generated. It has no copyright protection.
# In future, if significantly human edited, it may bear a copyright
# and a license.
# ====================================================================

server {
    listen 8080;
    listen [::]:8080;    
    # Optional SSL for development (uncomment if needed)
    #listen 8080 ssl;
    #listen [::]:8080 ssl;
    #ssl_certificate @SSL_CERT_FILE@;
    #ssl_certificate_key @SSL_KEY_FILE@;
    server_name @BROCHAT_DOMAIN@;

    # Root directory for the project
    root @BROCHAT_WEBROOT@;
    index index.php index.html;

    # Disable caching for development
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
    add_header Pragma "no-cache";

    # Debugging Headers
    add_header X-Debug "Development Mode";

    # Basic security headers (still useful in development)
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    location / {
        # First attempt to serve request as file, then
        # as directory, then fall back to displaying a 404.
        try_files $uri $uri/ =404;
    }

    ##
    # Pass PHP scripts to FastCGI server
    #
    location ~ ^/public/.*\.php$ {
        include snippets/fastcgi-php.conf; 

        # With php-fpm:
        # N.B. This Unix socket location has to match the
        # one given in the PHP FPM configuration file. On
        # Ubuntu, search for it at 
        # /etc/php/8.3/fpm/pool.d/www.conf
        fastcgi_pass unix:@PHP_FPM_SOCK@;

        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # Allow browsing private files for debugging (DO NOT use in production)
    location /private/ {
        root @BROCHAT_PROJECTDIR@;
        autoindex on;
    }

    # Static files (CSS, JS, images)
    location /assets/ {
        root @BROCHAT_PROJECTDIR@;
        autoindex on;
    }

    # WebSocket proxy for local development
    location /ws/ {
        proxy_pass http://@BROCHAT_DOMAIN@:@WEBSOCKET_PORT@;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    # Logging
    access_log @BROCHAT_LOGDIR@/access.log;
    error_log @BROCHAT_LOGDIR@/error.log;    
}
