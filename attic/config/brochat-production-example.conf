# ====================================================================
# BroChat Production Nginx Configuration
# Copyright (c) 2025 Michael Zran
#
# NO WARRANTY: THIS SOFTWARE IS PROVIDED "AS IS" WITHOUT ANY EXPRESS OR
# IMPLIED WARRANTIES, INCLUDING BUT NOT LIMITED TO WARRANTIES OF 
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT.
#
# USE AT YOUR OWN RISK: THE AUTHORS AND CONTRIBUTORS ASSUME NO RESPONSIBILITY 
# FOR ANY ISSUES ARISING FROM THE USE OF THIS CONFIGURATION, INCLUDING BUT 
# NOT LIMITED TO DATA LOSS, SECURITY BREACHES, OR PERFORMANCE ISSUES.
#
# By using this configuration, you acknowledge that it is your responsibility 
# to test, secure, and verify its suitability for your application.
#
# This file was primarily AI generated. It has no copyright protection.
# In future, if significantly human edited, it may bear a copyright
# and a license.
# ====================================================================


server {
    listen 443 ssl;
    listen [::]:443 ssl;    
    server_name yourdomain.com;

    # SSL settings (ensure you have a valid certificate)
    ssl_certificate /etc/ssl/certs/cert.pem;
    ssl_certificate_key /etc/ssl/private/cert.key;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; connect-src 'self' ws://your-websocket-server.com;" always;

    # Public directory (WEBROOT)
    root /var/www/brochat/public;
    index index.php index.html;

	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		try_files $uri $uri/ =404;
	}

    ##
    # Pass PHP scripts to FastCGI server
	#
    location ~ ^/public/.*\.php$ {
		include snippets/fastcgi-php.conf; 

		# With php-fpm:
        # N.B. This Unix socket location has to match the
        # one given in the PHP FPM configuration file. On
        # Ubuntu, search for it at 
        # /etc/php/8.3/fpm/pool.d/www.conf
		fastcgi_pass unix:/run/php/php8.3-fpm.sock;

        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # Deny direct access to private PHP files
    location ~ ^/private/.*\.php$ {
        deny all;
    }

    # Static out-of-tree assets (CSS, JS, images)
    location /assets/ {
        root /var/www/brochat/assets;
        autoindex off;
    }

    # WebSocket proxy
    location /ws/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    # Logging
    access_log /var/log/brochat/access.log;
    error_log /var/log/brochat/error.log;  
}
